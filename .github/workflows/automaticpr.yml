name: Auto Create Pull Request

on:
  push:
    branches:
      - 'feature/**'  # Triggers para branches que comeÃ§am com 'feature/'
      - 'developer'   # Trigger para a branch developer
    # Removido branches-ignore - nÃ£o pode usar ambos no mesmo evento

jobs:
  test-and-create-pr:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch todo o histÃ³rico para comparar branches
    
    # Setup para Java 21
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: maven
    
    - name: Find Maven project directory
      id: find-maven
      run: |
        echo "ðŸ” Procurando por pom.xml..."
        if [ -f "plus/pom.xml" ]; then
          echo "ðŸ“ pom.xml encontrado em plus/"
          echo "maven_dir=plus" >> $GITHUB_OUTPUT
        elif [ -f "pom.xml" ]; then
          echo "ðŸ“ pom.xml encontrado na raiz"
          echo "maven_dir=." >> $GITHUB_OUTPUT
        elif [ -f "backend/pom.xml" ]; then
          echo "ðŸ“ pom.xml encontrado em backend/"
          echo "maven_dir=backend" >> $GITHUB_OUTPUT
        elif [ -f "server/pom.xml" ]; then
          echo "ðŸ“ pom.xml encontrado em server/"
          echo "maven_dir=server" >> $GITHUB_OUTPUT
        elif [ -f "api/pom.xml" ]; then
          echo "ðŸ“ pom.xml encontrado em api/"
          echo "maven_dir=api" >> $GITHUB_OUTPUT
        else
          echo "âŒ pom.xml nÃ£o encontrado!"
          echo "ðŸ“‚ Estrutura do projeto:"
          find . -name "pom.xml" -type f | head -10
          echo "ðŸ“‚ ConteÃºdo da raiz:"
          ls -la
          exit 1
        fi

    - name: Install dependencies and compile
      run: |
        echo "ðŸ“¦ Instalando dependÃªncias e compilando..."
        cd ${{ steps.find-maven.outputs.maven_dir }}
        
        # CompilaÃ§Ã£o com mais detalhes para debug
        mvn clean compile \
          -DskipTests=true \
          --batch-mode \
          --no-transfer-progress \
          -e
          
        echo "âœ… CompilaÃ§Ã£o concluÃ­da!"
        
        # Verifica se hÃ¡ problemas de dependÃªncias
        echo "ðŸ” Verificando Ã¡rvore de dependÃªncias..."
        mvn dependency:tree -Dscope=test | head -20
    
    - name: Setup test environment
      run: |
        echo "ðŸ”§ Configurando ambiente de teste..."
        cd ${{ steps.find-maven.outputs.maven_dir }}
        
        # Cria perfil de teste se nÃ£o existir
        if [ ! -f "src/main/resources/application-test.properties" ] && [ ! -f "src/main/resources/application-test.yml" ]; then
          echo "ðŸ“ Criando configuraÃ§Ã£o de teste bÃ¡sica..."
          mkdir -p src/test/resources
          cat > src/test/resources/application-test.properties << EOF
# ConfiguraÃ§Ã£o bÃ¡sica para testes
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driver-class-name=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=
spring.h2.console.enabled=true
spring.jpa.hibernate.ddl-auto=create-drop
spring.jpa.show-sql=true
logging.level.org.springframework.web=DEBUG
logging.level.org.hibernate=DEBUG
EOF
        fi
        
        # Verifica se hÃ¡ testes para executar
        echo "ðŸ” Verificando testes disponÃ­veis..."
        TEST_COUNT=$(find src/test -name "*.java" -type f | wc -l)
        echo "ðŸ“Š Encontrados $TEST_COUNT arquivos de teste"
        
        if [ "$TEST_COUNT" -eq 0 ]; then
          echo "âš ï¸ Nenhum teste encontrado - pulando execuÃ§Ã£o de testes"
          echo "skip_tests=true" >> $GITHUB_ENV
        else
          echo "skip_tests=false" >> $GITHUB_ENV
        fi

    - name: Run tests
      if: env.skip_tests != 'true'
      run: |
        echo "ðŸ§ª Executando testes unitÃ¡rios..."
        cd ${{ steps.find-maven.outputs.maven_dir }}
        
        # Executa testes com configuraÃ§Ãµes mais detalhadas
        mvn test \
          -Dmaven.test.failure.ignore=false \
          -Dsurefire.useFile=false \
          -Dspring.profiles.active=test \
          --batch-mode \
          --no-transfer-progress \
          -e
        
        echo "âœ… Todos os testes passaram!"
      continue-on-error: false
      
    - name: Skip tests notification
      if: env.skip_tests == 'true'
      run: |
        echo "â„¹ï¸ Nenhum teste encontrado - pulando execuÃ§Ã£o de testes"
        echo "ðŸ’¡ Considere adicionar testes ao seu projeto em src/test/java/"
    
    # VerificaÃ§Ãµes adicionais para projetos Java
    - name: Generate test report
      if: always()  # Sempre executa mesmo se os testes falharem
      run: |
        echo "ðŸ“Š Gerando relatÃ³rio de testes..."
        cd ${{ steps.find-maven.outputs.maven_dir }}
        
        # Mostra informaÃ§Ãµes detalhadas sobre falhas de teste
        if [ -d "target/surefire-reports" ]; then
          echo "ðŸ“‹ RelatÃ³rios encontrados em target/surefire-reports/"
          ls -la target/surefire-reports/
          
          # Mostra conteÃºdo dos arquivos de erro se existirem
          echo "ðŸ” Verificando falhas de teste..."
          if ls target/surefire-reports/*-output.txt 1> /dev/null 2>&1; then
            echo "ðŸ“„ SaÃ­da dos testes:"
            cat target/surefire-reports/*-output.txt
          fi
          
          if ls target/surefire-reports/TEST-*.xml 1> /dev/null 2>&1; then
            echo "ðŸ“Š Resumo dos testes:"
            grep -h "testcase.*failure\|testcase.*error\|testsuite" target/surefire-reports/TEST-*.xml | head -20
          fi
        else
          echo "âš ï¸ Nenhum relatÃ³rio de teste encontrado"
        fi
        
        # Verifica logs do Spring Boot se existirem
        if [ -f "target/spring.log" ]; then
          echo "ðŸ“œ Ãšltimas linhas do log do Spring:"
          tail -50 target/spring.log
        fi
    
    - name: Check code quality (optional)
      continue-on-error: true  # NÃ£o falha se nÃ£o tiver configurado
      run: |
        echo "ðŸ” Verificando qualidade do cÃ³digo..."
        cd ${{ steps.find-maven.outputs.maven_dir }}
        # Executar verificaÃ§Ãµes de estilo se tiver configurado
        mvn checkstyle:check -DskipTests=true || echo "âš ï¸  Checkstyle nÃ£o configurado"
        
        # SpotBugs se tiver configurado  
        mvn spotbugs:check -DskipTests=true || echo "âš ï¸  SpotBugs nÃ£o configurado"
    
    - name: Check if PR already exists
      id: check-pr
      run: |
        # Verifica se jÃ¡ existe um PR para esta branch
        PR_EXISTS=$(gh pr list --head "${GITHUB_REF_NAME}" --state open --json number --jq '. | length')
        echo "pr_exists=$PR_EXISTS" >> $GITHUB_OUTPUT
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create Pull Request
      if: steps.check-pr.outputs.pr_exists == '0'
      run: |
        # Define a branch base (padrÃ£o: main)
        BASE_BRANCH="main"
        
        # LÃ³gica para determinar branch base baseada no nome da branch
        if [[ "${GITHUB_REF_NAME}" == feature/* ]]; then
          BASE_BRANCH="developer"  # Features vÃ£o para developer
        elif [[ "${GITHUB_REF_NAME}" == "developer" ]]; then
          BASE_BRANCH="main"       # Developer vai para main
        fi
        
        # Gera tÃ­tulo do PR baseado no nome da branch
        PR_TITLE=$(echo "${GITHUB_REF_NAME}" | sed 's/.*\///g' | sed 's/-/ /g' | sed 's/\b\w/\u&/g')
        
        # Gera corpo do PR com informaÃ§Ãµes do Ãºltimo commit
        LAST_COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
        LAST_COMMIT_AUTHOR=$(git log -1 --pretty=format:"%an")
        
        PR_BODY="## AlteraÃ§Ãµes
        
        Ãšltimas alteraÃ§Ãµes feitas nesta branch:
        - **Ãšltimo commit:** $LAST_COMMIT_MESSAGE
        - **Autor:** $LAST_COMMIT_AUTHOR
        
        ## âœ… VerificaÃ§Ãµes Automatizadas
        - [x] **Build Maven**: CompilaÃ§Ã£o bem-sucedida
        - [x] **Testes unitÃ¡rios**: Todos os testes passaram
        - [x] **Java 21**: Compatibilidade verificada
        - [x] **Spring Boot 3.5.0**: DependÃªncias resolvidas
        
        ## Tecnologias do Projeto
        - **Java**: 21
        - **Spring Boot**: 3.5.0
        - **Banco**: PostgreSQL
        - **SeguranÃ§a**: Spring Security + JWT
        - **Mapeamento**: MapStruct + Lombok
        
        ## Tipo de mudanÃ§a
        - [ ] Bug fix
        - [ ] Nova funcionalidade  
        - [ ] Breaking change
        - [ ] DocumentaÃ§Ã£o
        - [ ] RefatoraÃ§Ã£o
        
        ## Checklist
        - [x] CÃ³digo compilado sem erros
        - [x] Testes unitÃ¡rios passando
        - [x] DependÃªncias Maven resolvidas
        - [ ] DocumentaÃ§Ã£o atualizada
        - [ ] Code review solicitado
        
        ---
        *PR criado automaticamente via GitHub Actions*
        *Build e testes executados automaticamente*"
        
        # Cria o Pull Request
        gh pr create \
          --title "âœ… $PR_TITLE" \
          --body "$PR_BODY" \
          --base "$BASE_BRANCH" \
          --head "${GITHUB_REF_NAME}" \
          --assignee "@me"
        
        echo "âœ… Pull Request criado automaticamente!"
        echo "ðŸ§ª Testes executados com sucesso!"
        echo "ðŸ“‹ TÃ­tulo: âœ… $PR_TITLE"
        echo "ðŸŽ¯ Base: $BASE_BRANCH <- ${GITHUB_REF_NAME}"
        
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: PR already exists
      if: steps.check-pr.outputs.pr_exists != '0'
      run: |
        echo "â„¹ï¸  Pull Request jÃ¡ existe para a branch ${GITHUB_REF_NAME}"
        gh pr list --head "${GITHUB_REF_NAME}" --state open
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
